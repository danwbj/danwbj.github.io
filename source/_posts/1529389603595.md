---
title: consul入门
date: 2018-06-19 14:26:55
tags: [consul, 分布式，微服务]
category: [其他]
---

### 概述

consul 是一个服务发现、服务配置的工具，具有以下特征：

- 服务发现
- 健康检查
- key/value 存储
- 多数据中心

consul 每个节点都需要运行 agent，他有两种运行模式 server 和 client。每个数据中心官方建议需要 3 或 5 个 server 节点

- server 模式  
  服务端模式下，它会把所有的信息持久化的本地，这样遇到故障，信息是可以被保留的
- client 模式  
  客户端是一个非常轻量级的进程，它注册服务，运行健康检查，以及转发查询到服务器，不会持久化信息

### 安装

在 consul 官网下载页面找到和系统匹配的安装包，这里以 linux 为列
首先下载二进制包并解压

```
# wget https://releases.hashicorp.com/consul/1.1.0/consul_1.1.0_linux_amd64.zip
unzip consul_1.1.0_linux_amd64.zip
```

配置环境变量，使其全局生效,编辑系统变量文件 /etc/profile 在末尾增加如下配置：

```
# export PATH=$PATH:/consul_path/  （此处填写解压后的consul文件地址）
```

使环境变量立即生效

```
# source /etc/profile
```

执行 consul 命令，看到 consul 提示，说明 consul 安装成功

```
# consul
Usage: consul [--version] [--help] <command> [<args>]

Available commands are:
    agent          Runs a Consul agent
    catalog        Interact with the catalog
    event          Fire a new event
    exec           Executes a command on Consul nodes
    force-leave    Forces a member of the cluster to enter the "left" state
    info           Provides debugging information for operators.
    join           Tell Consul agent to join cluster
    keygen         Generates a new encryption key
    keyring        Manages gossip layer encryption keys
    kv             Interact with the key-value store
    leave          Gracefully leaves the Consul cluster and shuts down
    lock           Execute a command holding a lock
    maint          Controls node or service maintenance mode
    members        Lists the members of a Consul cluster
    monitor        Stream logs from a Consul agent
    operator       Provides cluster-level tools for Consul operators
    reload         Triggers the agent to reload configuration files
    rtt            Estimates network round trip time between nodes
    snapshot       Saves, restores and inspects snapshots of Consul server state
    validate       Validate config files/directories
    version        Prints the Consul version
    watch          Watch for changes in Consul
```

### 运行 Agent

使用 dev 模式可以简单地启动一个单节点 consul 服务

```
# consul agent -dev
==> Starting Consul agent...
==> Consul agent running!
           Version: 'v1.1.0'
           Node ID: '49afc899-5629-adaf-b008-3dd6ca5da620'
         Node name: 'danw-MacBook-Pro'
        Datacenter: 'dc1' (Segment: '<all>')
            Server: true (Bootstrap: false)
       Client Addr: [127.0.0.1] (HTTP: 8500, HTTPS: -1, DNS: 8600)
      Cluster Addr: 127.0.0.1 (LAN: 8301, WAN: 8302)
           Encrypt: Gossip: false, TLS-Outgoing: false, TLS-Incoming: false

==> Log data will now stream in as it occurs:

    2018/06/19 15:11:38 [DEBUG] agent: Using random ID "49afc899-5629-adaf-b008-3dd6ca5da620" as node ID
    2018/06/19 15:11:38 [INFO] raft: Initial configuration (index=1): [{Suffrage:Voter ID:49afc899-5629-adaf-b008-3dd6ca5da620 Address:127.0.0.1:8300}]
    2018/06/19 15:11:38 [INFO] raft: Node at 127.0.0.1:8300 [Follower] entering Follower state (Leader: "")
    2018/06/19 15:11:38 [INFO] serf: EventMemberJoin: danw-MacBook-Pro.dc1 127.0.0.1
    2018/06/19 15:11:38 [INFO] serf: EventMemberJoin: danw-MacBook-Pro 127.0.0.1
    2018/06/19 15:11:38 [INFO] consul: Adding LAN server danw-MacBook-Pro (Addr: tcp/127.0.0.1:8300) (DC: dc1)
    2018/06/19 15:11:38 [INFO] consul: Handled member-join event for server "danw-MacBook-Pro.dc1" in area "wan"
    2018/06/19 15:11:38 [INFO] agent: Started DNS server 127.0.0.1:8600 (tcp)
    2018/06/19 15:11:38 [INFO] agent: Started DNS server 127.0.0.1:8600 (udp)
    2018/06/19 15:11:38 [INFO] agent: Started HTTP server on 127.0.0.1:8500 (tcp)
    2018/06/19 15:11:38 [INFO] agent: started state syncer
    2018/06/19 15:11:38 [WARN] raft: Heartbeat timeout from "" reached, starting election
    2018/06/19 15:11:38 [INFO] raft: Node at 127.0.0.1:8300 [Candidate] entering Candidate state in term 2
    2018/06/19 15:11:38 [DEBUG] raft: Votes needed: 1
    2018/06/19 15:11:38 [DEBUG] raft: Vote granted from 49afc899-5629-adaf-b008-3dd6ca5da620 in term 2. Tally: 1
    2018/06/19 15:11:38 [INFO] raft: Election won. Tally: 1
    2018/06/19 15:11:38 [INFO] raft: Node at 127.0.0.1:8300 [Leader] entering Leader state
    2018/06/19 15:11:38 [INFO] consul: cluster leadership acquired
    2018/06/19 15:11:38 [INFO] consul: New leader elected: danw-MacBook-Pro
    2018/06/19 15:11:38 [DEBUG] consul: Skipping self join check for "danw-MacBook-Pro" since the cluster is too small
    2018/06/19 15:11:38 [INFO] consul: member 'danw-MacBook-Pro' joined, marking health alive
    2018/06/19 15:11:38 [DEBUG] agent: Skipping remote check "serfHealth" since it is managed automatically
    2018/06/19 15:11:38 [INFO] agent: Synced node info
    2018/06/19 15:11:40 [DEBUG] agent: Skipping remote check "serfHealth" since it is managed automatically
    2018/06/19 15:11:40 [DEBUG] agent: Node info in sync
```

查看集群成员

```
# consul members
Node              Address         Status  Type    Build  Protocol  DC   Segment
danw-MacBook-Pro  127.0.0.1:8301  alive   server  1.1.0  2         dc1  <all>
```

### 停止 Agent

可以使用 ctrl+c 直接停止 agent 服务

### 搭建 consul 集群

前面只是运行了一个 dev 模式的 consul 环境，并不能用于生产环境，也不会持久化任何信息，接下来我们搭建 3 个节点的 consul 服务

准备三台虚拟机

| ip          | 虚拟名 |
| ----------- | ------ |
| 10.211.55.4 | s1     |
| 10.211.55.5 | s2     |
| 10.211.55.6 | s3     |

以下简称 s1,s2,s3

在每台虚机上执行对应的命令

s1:

```
# consul agent -server -bootstrap-expect 3 -data-dir /tmp/consul_server -node consul-one -bind 10.211.55.4 -client 0.0.0.0 -ui
```

s2:

```
# consul agent -server -bootstrap-expect 3 -data-dir /tmp/consul_server -node consul-two -bind 10.211.55.5 -client 0.0.0.0 -ui -join 10.211.55.4
```

s3:

```
# consul agent -server -bootstrap-expect 3 -data-dir /tmp/consul_server -node consul-three -bind 10.211.55.6 -client 0.0.0.0 -ui -join 10.211.55.5
```

参数说明：

- -server: 指定 agent 以 server 模式运行
- -bootstrap-expect: 期望的节点数，只有集群数量达到设置值，集群才会选举 leader
- -data-dir: 数据目录
- -node: 指定节点名称
- -bind: 为节点绑定地址
- -client: 指定 web ui、的监听地址，默认 127.0.0.1 只能本机访问
- -ui: 启用内置的静态 web UI 服务器(8500 端口)
- -join: 加入集群

三台虚机上的 consul 全部启动之后，查看集群节点

```
[root@centos-linux ~]# consul members
Node          Address           Status  Type    Build  Protocol  DC   Segment
consul-one    10.211.55.4:8301  alive  server  1.1.0  2         dc1  <all>
consul-three  10.211.55.6:8301  alive  server  1.1.0  2         dc1  <all>
consul-two    10.211.55.5:8301  alive  server  1.1.0  2         dc1  <all>
```

可以看到集群中已经有三个 alive 状态的节点  
打开浏览器访问http://10.211.55.4:8500可以看到集群信息

<!-- ![avatar](http://resource.hzdan.top:81/images/WX20180618-151026%402x.png) -->

![avatar](/images/WX20180619-154911@2x.png)
